datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

model Department {
  id            Int            @id @default(autoincrement())
  name          String         @unique @db.VarChar(255)
  teachingUnits TeachingUnit[]
  students      Student[]
}

model TeachingUnit {
  id           Int        @id @default(autoincrement())
  name         String     @db.VarChar(255)
  semester     Int
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId Int
  subjects     Subject[]

  @@index([departmentId], name: "teaching_unit_index_0")
}

model Subject {
  id             Int          @id @default(autoincrement())
  name           String       @db.VarChar(255)
  coefficient    Int
  teachingUnit   TeachingUnit @relation(fields: [teachingUnitId], references: [id])
  teachingUnitId Int
  assessments    Assessment[]

  @@index([teachingUnitId], name: "subject_index_0")
}

enum AssessmentType {
  CC
  TP
  EXAM
}

model Assessment {
  id          Int            @id @default(autoincrement())
  type        AssessmentType
  date        DateTime       @default(now())
  coefficient Int
  fileName    String         @db.VarChar(255)
  period      Int
  subject     Subject        @relation(fields: [subjectId], references: [id])
  subjectId   Int
  grades      Grade[]

  @@index([subjectId], name: "assessment_index_4")
}

model Grade {
  id           Int        @id @default(autoincrement())
  value        Float
  student      Student    @relation(fields: [studentId], references: [id])
  studentId    Int
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  assessmentId Int

  @@index([studentId], name: "grade_index_5")
  @@index([assessmentId], name: "grade_index_6")
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id             String    @id @default(cuid())
  name           String?   @db.VarChar(255)
  username       String?   @unique @db.VarChar(30)
  image          String?   @db.VarChar(255)
  hashedPassword String?   @db.VarChar(255)
  role           UserRole  @default(USER)
  emailVerified  DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  account        Account[]
}

model Student {
  id            Int        @id @default(autoincrement())
  lastName      String     @db.VarChar(50)
  firstName     String     @db.VarChar(50)
  studentNumber Int        @unique
  email         String     @unique
  entryYear     Int?
  level         Int
  departmentId  Int
  department    Department @relation(fields: [departmentId], references: [id])
  account       Account[]
  grades        Grade[]

  @@index([studentNumber], name: "student_index_0")
  @@index([departmentId], name: "student_index_1")
}

model Professor {
  id        Int       @id @default(autoincrement())
  lastName  String    @db.VarChar(50)
  firstName String    @db.VarChar(50)
  account   Account[]
}

enum AccountType {
  STUDENT
  PROFESSOR
}

model Account {
  id          String      @id @default(cuid())
  userId      String
  studentId   Int?
  professorId Int?
  type        AccountType
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  student     Student?    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  professor   Professor?  @relation(fields: [professorId], references: [id], onDelete: Cascade)

  @@unique([userId, studentId])
  @@unique([userId, professorId])
  @@index([studentId], name: "account_studentId_idx")
  @@index([professorId], name: "account_professorId_idx")
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}
